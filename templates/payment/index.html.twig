{% extends 'base.html.twig' %}

{% block title %}Offre Pro{% endblock %}

{% block body %}
    <div class="min-h-screen bg-amber-50 flex items-center justify-center px-6 py-20">

        <section class="bg-white border border-amber-200 rounded-lg shadow-md max-w-md w-full p-8 flex flex-col items-center">
            <div id="error-message" class="text-red-600 mb-4" style="display:none;"></div>


            <!-- Titre de l'offre -->
            <h2 class="text-3xl font-bold text-amber-700 mb-4 text-center">Pro Plan</h2>

            <!-- Prix -->
            <p class="text-amber-600 text-xl font-semibold mb-6 text-center">10.00 / month</p>

            <!-- Liste des avantages -->
            <ul class="list-disc list-inside text-gray-700 space-y-3 text-lg mb-8">
                <li>✔️ Accès complet à la gestion des menus</li>
                <li>✔️ Upload illimité de fichiers PDF</li>
                <li>✔️ Création manuelle de catégories et plats</li>
                <li>✔️ Support prioritaire 24/7</li>
                <li>✔️ Statistiques avancées en temps réel</li>
            </ul>

            {% if not hasSubscription %}

            <form action="{{ path('create_checkout_session') }}" method="POST" class="w-full">
                <input type="hidden" name="lookup_key" value="{{ PRICE_LOOKUP_KEY }}" />
                <button
                    id="checkout-button"
                    type="button"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-md font-semibold transition">
                    Payer
                </button>
            </form>
            {% endif %}
        </section>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('{{ stripe_public_key }}');
        const button = document.getElementById('checkout-button');

        button.addEventListener('click', () => {
            fetch('{{ path('create_checkout_session') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    lookup_key: '{{ PRICE_LOOKUP_KEY }}'
                })
            })
                .then(response => response.json())
                .then(data => {
                    return stripe.redirectToCheckout({ sessionId: data.id });
                })
                .then(result => {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                });
        });

        const errorMessageDiv = document.getElementById('error-message');

        button.addEventListener('click', () => {
            errorMessageDiv.style.display = 'none';
            errorMessageDiv.textContent = '';

            fetch('{{ path('create_checkout_session') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    lookup_key: '{{ PRICE_LOOKUP_KEY }}'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if(data.error) {
                        errorMessageDiv.textContent = data.error;
                        errorMessageDiv.style.display = 'block';
                        return;
                    }
                    return stripe.redirectToCheckout({ sessionId: data.id });
                })
                .then(result => {
                    if (result && result.error) {
                        errorMessageDiv.textContent = result.error.message;
                        errorMessageDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    errorMessageDiv.textContent = "Une erreur inattendue est survenue.";
                    errorMessageDiv.style.display = 'block';
                });
        });


    </script>
{% endblock %}
