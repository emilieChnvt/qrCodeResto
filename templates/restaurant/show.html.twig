{% extends 'base.html.twig' %}

{% block title %}Dashboard de {{ restaurant.name }}{% endblock %}

{% block body %}
    <div class="min-h-screen bg-amber-50 flex flex-col">

        <!-- Navbar -->
        <nav class="bg-white shadow-sm px-8 py-4 flex justify-between items-center sticky top-0 z-20 border-b border-amber-200">
            <h1 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
                üçΩÔ∏è {{ restaurant.name }}
            </h1>

            <div class="flex items-center gap-4 text-gray-700">
                <a href="{{ path('app_admin', {id: app.user.id}) }}"
                   class="hover:text-gray-900 font-medium flex items-center gap-1 transition">‚Üê Retour</a>

                <a href="{{ path('app_show_menu', {id: restaurant.id}) }}"
                   class="bg-amber-600 hover:bg-amber-700 text-white py-2 px-5 rounded-md shadow-sm transition flex items-center gap-2">
                    üìã Voir le menu
                </a>

                <div class="relative">
                    <button id="dropdownBtn"
                            class="bg-amber-600 hover:bg-amber-700 text-white py-2 px-4 rounded-md flex items-center gap-2 shadow-sm transition">
                        üîó QR Code
                    </button>
                    <div id="dropdownMenu" class="absolute right-0 hidden bg-white shadow-md mt-2 rounded-md border border-amber-200 w-64 z-30">
                        <a href="{{ path('app_qr_code', {id: restaurant.id, type: 'manual'}) }}"
                           class="block px-4 py-2 text-sm text-gray-800 hover:bg-amber-100 transition">üñãÔ∏è Menu √©crit manuellement</a>
                        {% if restaurant.menuFileName %}
                            <a href="{{ path('app_qr_code', {id: restaurant.id, type: 'pdf'}) }}"
                               class="block px-4 py-2 text-sm text-gray-800 hover:bg-amber-100 transition">üìÑ Menu PDF upload√©</a>
                        {% endif %}
                    </div>
                </div>

                <a href="{{ path('app_upload_menu', {id: restaurant.id}) }}"
                   class="bg-amber-100 hover:bg-amber-200 text-amber-900 py-2 px-5 rounded-md shadow-sm flex items-center gap-2 transition">
                    üìÅ Upload menu
                    {% if restaurant.menuFileName %}
                        <span title="Menu d√©j√† upload√©" class="text-amber-700 font-semibold">‚úÖ</span>
                    {% endif %}
                </a>
            </div>
        </nav>

        <!-- Main content -->
        <main class="flex-grow max-w-6xl mx-auto px-6 py-10 w-full space-y-12">

            <!-- Boutons -->
            <div class="flex justify-between items-center mb-8 gap-4 flex-wrap">
                <a href="{{ path('app_category_create', {id: restaurant.id}) }}"
                   class="bg-amber-600 hover:bg-amber-700 text-white py-2 px-5 rounded-md shadow-sm transition flex items-center gap-2">
                    ‚ûï Ajouter une cat√©gorie
                </a>

                <a href="{{ path('menu_create_restaurant', {id: restaurant.id}) }}"
                   class="bg-green-600 hover:bg-green-700 text-white py-2 px-5 rounded-md shadow-sm transition flex items-center gap-2">
                    ‚ûï Cr√©er un menu
                </a>
            </div>

            <!-- Cat√©gories & plats -->
            <div>
                <h2 class="text-xl font-bold text-gray-800 mb-4">Cat√©gories disponibles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for category in categories %}
                        <div class="bg-white rounded-lg shadow-sm border border-amber-200 p-6 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-5">
                                <h3 class="text-xl font-semibold text-gray-800">{{ category.name }}</h3>
                                <div class="flex gap-3">
                                    <a href="{{ path('app_menu_item_create', {id: category.id}) }}"
                                       class="text-amber-600 hover:text-amber-800 font-medium text-sm transition">‚ûï Plat</a>
                                    <a href="{{ path('delete_category', {id: category.id}) }}"
                                       class="text-red-500 hover:text-red-700 text-sm font-medium transition"
                                       onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette cat√©gorie ? Cela supprimera aussi tous ses plats.')">üóë Supprimer</a>
                                </div>
                            </div>

                            {% if category.menuItems is empty %}
                                <p class="text-gray-400 italic">Aucun plat dans cette cat√©gorie.</p>
                            {% else %}
                                <ul class="space-y-3">
                                    {% for item in category.menuItems %}
                                        <li class="bg-amber-50 p-3 rounded-lg border border-amber-100 flex justify-between items-center hover:bg-amber-100 transition">
                                            <div>
                                                <p class="text-gray-800 font-medium">
                                                    {{ item.name }}
                                                    {% if item.description %}
                                                        <span class="text-gray-600 text-xs ml-1">- {{ item.description }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <div class="text-right flex flex-col items-end gap-1">
                                                <p class="text-gray-700 font-semibold">{{ item.price|number_format(2, '.', ' ') }} ‚Ç¨</p>
                                                <a href="{{ path('app_delete_menu_item', {id: item.id}) }}"
                                                   class="text-red-500 text-sm hover:underline transition">Supprimer</a>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-center text-gray-400 col-span-full">Aucune cat√©gorie pour ce restaurant.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Menus disponibles -->
            {% if menus is defined and menus|length > 0 %}
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Menus cr√©√©s</h2>
                    <div class="space-y-6">
                        {% for menu in menus %}
                            <div class="bg-white border border-green-300 rounded-lg p-5 shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-semibold text-green-700">üìã {{ menu.name }}</h3>

                                    <div class="flex items-center gap-4">
                                        <p class="text-red-600 font-semibold text-lg">
                                            {{ menu.price|number_format(2, '.', ' ') }} ‚Ç¨
                                        </p>
                                        <a href="{{ path('app_delete_menu', {id: menu.id}) }}"
                                           class="text-red-500 text-sm hover:underline transition"
                                           onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce menu ?')">
                                            Supprimer
                                        </a>
                                        <a href="{{ path('app_edit_menu',{id:menu.id}) }}"  class="text-red-500 text-sm hover:underline transition">Modifier</a>
                                    </div>
                                </div>

                                {% if menu.categories is empty %}
                                    <p class="text-gray-400 italic">Aucune cat√©gorie li√©e.</p>
                                {% else %}
                                    <ul class="space-y-1 list-disc list-inside">
                                        {% for category in menu.categories %}
                                            {# Filtrer explicitement les plats li√©s au menu #}
                                            {% set itemsInMenu = [] %}
                                            {% for item in category.menuItems %}
                                                {% for m in item.menus %}
                                                    {% if m.id == menu.id %}
                                                        {% set itemsInMenu = itemsInMenu|merge([item]) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}

                                            <li>
                                                <strong>{{ category.name }}</strong> :
                                                {% if itemsInMenu is empty %}
                                                    <span class="text-gray-400 italic">aucun plat</span>
                                                {% else %}
                                                    {{ itemsInMenu|map(item => item.name)|join(', ') }}
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

        </main>
    </div>

    <script>
        function setupDropdown() {
            const btn = document.getElementById('dropdownBtn');
            const menu = document.getElementById('dropdownMenu');
            if (!btn || !menu) return;

            btn.onclick = (e) => {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            };
            menu.onclick = (e) => e.stopPropagation();
            document.onclick = () => menu.classList.add('hidden');
            document.onkeydown = (e) => { if (e.key === 'Escape') menu.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', setupDropdown);
        document.addEventListener('turbo:load', setupDropdown);
    </script>
{% endblock %}
